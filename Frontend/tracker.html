<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOM Action Tracker</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --text: #1e293b; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding: 2rem; max-width: 1400px; margin: 0 auto; }
        
        /* HEADER SECTION */
        header { display: flex; align-items: center; gap: 1.5rem; background: var(--surface); padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 2rem; border: 1px solid var(--border); }
        header img { height: 50px; width: auto; }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary); }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .stat-label { font-size: 0.875rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; }
        .text-red { color: var(--danger); } 
        .progress-bg { height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }

        /* Controls */
        .controls { display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center; }
        button { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        
        /* --- NEW FILTER BAR STYLES --- */
        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            background: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        .filter-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem; }
        .filter-group input, .filter-group select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }

        /* Table */
        .table-container { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: #f1f5f9; font-weight: 600; color: #475569; }
        
        /* Badges & Buttons */
        .badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .badge-high { background: #fee2e2; color: #991b1b; }
        .badge-med { background: #fef3c7; color: #92400e; }
        .badge-low { background: #d1fae5; color: #065f46; }
        .badge-closed { background: #dcfce7; color: #166534; }
        .badge-wip { background: #e0f2fe; color: #075985; }
        .badge-overdue { background: #7f1d1d; color: white; }
        .action-btn { background: transparent; padding: 5px; font-size: 1.1rem; margin-right: 5px; color: #64748b; border: none; cursor: pointer; }
        .action-btn:hover { background: #f1f5f9; border-radius: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 500px; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
    </style>
</head>
<body>

    <header>
        <img src="https://ik.imagekit.io/hiteshh12/logo.png" alt="Company Logo" onerror="this.style.display='none'"> 
        <div>
            <h1>MOM Action Tracker</h1>
            <span style="color: #64748b; font-size: 0.9rem;">Internal Tracking System</span>
        </div>
    </header>

    <div class="dashboard-grid">
        <div class="card"><div class="stat-label">Total Tasks</div><div class="stat-value" id="stat-total">0</div></div>
        <div class="card"><div class="stat-label">Pending / WIP</div><div class="stat-value" id="stat-wip">0</div></div>
        <div class="card"><div class="stat-label">Overdue</div><div class="stat-value text-red" id="stat-overdue">0</div></div>
        <div class="card">
            <div class="stat-label">Completion Rate</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="stat-value" style="color:var(--success)" id="stat-rate">0%</div>
            </div>
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
        </div>
    </div>

    <div class="controls">
        <h2 style="margin:0; font-size:1.2rem; color:var(--text);">Action Items</h2>
        <div style="gap: 10px; display: flex;">
            <button class="outline" onclick="exportToCSV()">‚¨á Download CSV</button>
            <button onclick="openModal()">+ Add New Item</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-group">
            <label>üîé Search Action Item</label>
            <input type="text" id="filter-text" placeholder="Type to search..." onkeyup="applyFilters()">
        </div>
        <div class="filter-group">
            <label>üìÇ Category</label>
            <select id="filter-category" onchange="applyFilters()">
                <option value="">All Categories</option>
                <option value="System & Tech">System & Tech</option>
                <option value="HR & Policy">HR & Policy</option>
                <option value="Ops & Training">Ops & Training</option>
                <option value="Data & Reporting">Data & Reporting</option>
            </select>
        </div>
        <div class="filter-group">
            <label>üë§ Owner</label>
            <input type="text" id="filter-owner" placeholder="Filter by owner..." onkeyup="applyFilters()">
        </div>
        <div class="filter-group">
            <label>üìå Status</label>
            <select id="filter-status" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="Not Started">Not Started</option>
                <option value="WIP">WIP</option>
                <option value="Closed">Closed</option>
                <option value="Overdue">‚ö†Ô∏è Overdue Only</option>
            </select>
        </div>
        <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button class="outline" onclick="clearFilters()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Clear</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="12%">Category</th>
                    <th width="25%">Action Item</th>
                    <th width="10%">Owner</th>
                    <th width="8%">Priority</th>
                    <th width="10%">Target Date</th>
                    <th width="10%">Status</th>
                    <th width="15%">Remarks</th>
                    <th width="10%">Actions</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0;">Add New Task</h3>
            <form onsubmit="saveTask(event)">
                <input type="hidden" id="inp-id">
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="inp-category" placeholder="e.g. System, HR, Ops" required list="category-suggestions">
                    <datalist id="category-suggestions">
                        <option value="System & Tech"><option value="HR & Policy"><option value="Ops & Training"><option value="Data & Reporting">
                    </datalist>
                </div>
                <div class="form-group"><label>Action Item</label><input type="text" id="inp-desc" required></div>
                <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                    <div class="form-group"><label>Owner</label><input type="text" id="inp-owner"></div>
                    <div class="form-group"><label>Priority</label><select id="inp-priority"><option>High</option><option selected>Medium</option><option>Low</option></select></div>
                </div>
                <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                    <div class="form-group"><label>Target Date</label><input type="date" id="inp-date"></div>
                    <div class="form-group"><label>Status</label><select id="inp-status"><option>Not Started</option><option>WIP</option><option>Closed</option></select></div>
                </div>
                <div class="form-group"><label>Remarks</label><textarea id="inp-remarks" rows="2"></textarea></div>
                <div style="text-align:right; margin-top:1.5rem;">
                    <button type="button" class="outline" onclick="closeModal()">Cancel</button>
                    <button type="submit">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://mom-z2cz.onrender.com/tasks';
        let allTasks = []; // Store ALL data here
        let displayedTasks = []; // Store FILTERED data here

        // === 1. Fetch & Init ===
        async function fetchTasks() {
            try {
                const res = await fetch(API_URL);
                allTasks = await res.json();
                applyFilters(); // Initial render uses filters (which are empty at start)
            } catch (err) { console.error("API Error:", err); }
        }

        // === 2. Filter Logic (Local Only) ===
        function applyFilters() {
            const searchText = document.getElementById('filter-text').value.toLowerCase();
            const categoryVal = document.getElementById('filter-category').value;
            const ownerText = document.getElementById('filter-owner').value.toLowerCase();
            const statusVal = document.getElementById('filter-status').value;

            displayedTasks = allTasks.filter(task => {
                // 1. Text Search
                const matchesText = (task.desc || "").toLowerCase().includes(searchText);
                
                // 2. Category Filter
                const matchesCategory = categoryVal === "" || (task.category || "") === categoryVal;
                
                // 3. Owner Filter
                const matchesOwner = (task.owner || "").toLowerCase().includes(ownerText);

                // 4. Status Filter
                let matchesStatus = true;
                if (statusVal === "Overdue") {
                    // Special logic for overdue
                    matchesStatus = task.targetDate && new Date(task.targetDate) < new Date() && task.status !== 'Closed';
                } else if (statusVal !== "") {
                    matchesStatus = task.status === statusVal;
                }

                return matchesText && matchesCategory && matchesOwner && matchesStatus;
            });

            renderTable();
            updateStats(); // Update stats based on filtered view OR full view? usually full view is better for stats.
            // Let's keep stats based on FULL data so you always see project health
            updateStats(allTasks); 
        }

        function clearFilters() {
            document.getElementById('filter-text').value = "";
            document.getElementById('filter-category').value = "";
            document.getElementById('filter-owner').value = "";
            document.getElementById('filter-status').value = "";
            applyFilters();
        }

        // === 3. Render Table ===
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(displayedTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem; color:#64748b;">No matching tasks found</td></tr>';
                return;
            }

            displayedTasks.forEach(task => {
                const isOverdue = task.targetDate && new Date(task.targetDate) < new Date() && task.status !== 'Closed';
                const dateStr = task.targetDate ? new Date(task.targetDate).toISOString().split('T')[0] : '--';
                
                let priorityClass = task.priority === 'High' ? 'badge-high' : (task.priority === 'Low' ? 'badge-low' : 'badge-med');
                let statusClass = task.status === 'Closed' ? 'badge-closed' : (task.status === 'WIP' ? 'badge-wip' : '');
                if(isOverdue) statusClass = 'badge-overdue';

                tbody.innerHTML += `
                    <tr>
                        <td><b>${task.category}</b></td>
                        <td>${task.desc}</td>
                        <td>${task.owner || '-'}</td>
                        <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                        <td>${dateStr}</td>
                        <td><span class="badge ${statusClass}">${isOverdue ? 'Overdue' : task.status}</span></td>
                        <td style="font-size:0.9rem; color:#64748b;">${task.remarks || ''}</td>
                        <td>
                            <button class="action-btn" onclick="openEditModal('${task._id}')" title="Edit">‚úé</button>
                            <button class="action-btn" onclick="deleteTask('${task._id}')" title="Delete" style="color:var(--danger)">üóë</button>
                        </td>
                    </tr>`;
            });
        }

        // === 4. Dashboard Stats (Always calculates on FULL dataset) ===
        function updateStats(dataSet = allTasks) {
            const total = dataSet.length;
            const closed = dataSet.filter(t => t.status === 'Closed').length;
            const wip = dataSet.filter(t => t.status === 'WIP').length;
            const overdue = dataSet.filter(t => t.targetDate && new Date(t.targetDate) < new Date() && t.status !== 'Closed').length;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-wip').innerText = wip;
            document.getElementById('stat-overdue').innerText = overdue;
            
            const rate = total === 0 ? 0 : Math.round((closed / total) * 100);
            document.getElementById('stat-rate').innerText = rate + '%';
            document.getElementById('progress-bar').style.width = rate + '%';
        }

        // === 5. CRUD Operations (Same as before) ===
        function openModal() { document.getElementById('taskModal').classList.add('active'); document.querySelector('form').reset(); document.getElementById('inp-id').value = ""; }
        function closeModal() { document.getElementById('taskModal').classList.remove('active'); }

        function openEditModal(id) {
            const task = allTasks.find(t => t._id === id);
            if(!task) return;
            document.getElementById('taskModal').classList.add('active');
            document.getElementById('modal-title').innerText = "Edit Task";
            document.getElementById('inp-id').value = task._id;
            document.getElementById('inp-category').value = task.category;
            document.getElementById('inp-desc').value = task.desc;
            document.getElementById('inp-owner').value = task.owner;
            document.getElementById('inp-priority').value = task.priority;
            document.getElementById('inp-status').value = task.status;
            document.getElementById('inp-remarks').value = task.remarks || "";
            if(task.targetDate) document.getElementById('inp-date').value = new Date(task.targetDate).toISOString().split('T')[0];
        }

        async function saveTask(e) {
            e.preventDefault();
            const id = document.getElementById('inp-id').value;
            const payload = {
                category: document.getElementById('inp-category').value,
                desc: document.getElementById('inp-desc').value,
                owner: document.getElementById('inp-owner').value,
                priority: document.getElementById('inp-priority').value,
                status: document.getElementById('inp-status').value,
                targetDate: document.getElementById('inp-date').value,
                remarks: document.getElementById('inp-remarks').value
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;
            await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            closeModal();
            fetchTasks(); // Reloads data and re-applies filters
        }

        async function deleteTask(id) {
            if(confirm('Delete this task?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                fetchTasks();
            }
        }

        function exportToCSV() {
            // Export the FILTERED list, or change to allTasks to export everything
            let dataToExport = displayedTasks; 
            let csvContent = "data:text/csv;charset=utf-8,Category,Action Item,Owner,Priority,Target Date,Status,Remarks\n";
            dataToExport.forEach(t => {
                const date = t.targetDate ? new Date(t.targetDate).toISOString().split('T')[0] : '';
                const desc = `"${(t.desc || '').replace(/"/g, '""')}"`;
                const remarks = `"${(t.remarks || '').replace(/"/g, '""')}"`;
                csvContent += [t.category, desc, t.owner, t.priority, date, t.status, remarks].join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "MOM_Tracker_Export.csv");
            document.body.appendChild(link);
            link.click();
        }

        // Initial Load
        fetchTasks();
    </script>
</body>
</html>